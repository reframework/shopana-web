version: "3.8"

services:
  nginx:
    image: nginx:${NGINX_VERSION:-latest}
    container_name: nginx
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - ./nginx.conf.template:/etc/nginx/templates/nginx.conf.template
      - "${HOST_CMSAPI_FILES_DIR}:${NGINX_CMSAPI_FILES_DIR}:ro"
    ports:
      - "80:80"
    command: >
      /bin/bash -c "envsubst \"`for v in $$(compgen -v);do printf '$${%s} ' $$v;done`'\"
      < /etc/nginx/templates/nginx.conf.template
      > /etc/nginx/conf.d/default.conf
      && nginx -g 'daemon off;'"
    depends_on:
      - web-client
      - web-api
      - cms

  web-client:
    image: ghcr.io/reframework/shopana-web-client:${WEB_CLIENT_VERSION:-latest}
    restart: unless-stopped

  web-api:
    image: ghcr.io/reframework/shopana-web-api:${WEB_API_VERSION:-latest}
    restart: unless-stopped
    depends_on:
      - web-migration
      - postgres

  cms:
    image: ghcr.io/reframework/shopana-cms:${CMS_VERSION:-latest}
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - "${HOST_CMSAPI_FILES_DIR}:${CMSAPI_FILES_DIR}"
    depends_on:
      - cms-migration
      - postgres

  cms-migration:
    image: ghcr.io/reframework/shopana-cms-migration:${CMS_MIGRATION_VERSION:-latest}
    restart: on-failure
    env_file:
      - .env
    depends_on:
      - postgres

  platform-migration:
    image: ghcr.io/reframework/shopana-platform-migration:${WEB_MIGRATION_VERSION:-latest}
    restart: on-failure
    env_file:
      - .env
    depends_on:
      - postgres

  platform-postgres:
    image: ghcr.io/reframework/shopana-platform-postgres:${POSTGRES_VERSION:-latest}
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - "${HOST_DB_DATA}:/var/lib/postgresql/data"
